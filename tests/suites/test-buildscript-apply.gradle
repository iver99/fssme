//-----------------------------------------------------------------------------
// Enable this to be a rootProject which uses project common files.
//
// Configure the project classpath to enable applying plugins,
// and define some global project properties and methods.
// -- gradle runs the buildscript block first during the configuration phase
//
buildscript {
  if (System.env.BRANCH_TOP_DIR) {
    project.ext.commonBranchTopDir = System.env.BRANCH_TOP_DIR
  } else {
    def command = "cd '$rootDir' && git rev-parse --show-toplevel"
    def stdout = new StringBuilder(); def stderr = new StringBuilder(); def exitCode = 1
    try {
      def proc = new ProcessBuilder("sh", "-c", command).start()
      proc.waitForProcessOutput(stdout, stderr); exitCode = proc.exitValue()
    } catch (Exception e) { stderr << e.message }
    if (exitCode) {
      throw new GradleException (
        "[ERROR] sh or git command is not found or pwd=${System.properties.'user.dir'} is not a git project dir\n" +
        "[Note] If git is not available, env variables BRANCH_TOP_DIR and BRANCH_NAME must be set\n" +
        "[Command] sh -c \"$command\"\n" + "[Error] $stderr")
    } else {
      project.ext.commonBranchTopDir = "$stdout".trim()
    }
  }
  apply from: "$project.commonBranchTopDir/common/scripts/buildscript-apply-delegate.gradle"
}
//
// Apply common plugins,
// configure the common publishing repository,
// configure project repositories to resolve artifact specs,
// and do other common configuration for allprojects{}.
//
def pubAllprojects = project.hasProperty('PUB_ALLPROJECTS') ?
  project.PUB_ALLPROJECTS : "$project.pubBuildscriptDir/allprojects.gradle"
apply from: new File(pubAllprojects).isAbsolute() ?
  "$pubAllprojects" : "$project.commonBranchTopDir/$pubAllprojects"
//
//-----------------------------------------------------------------------------
